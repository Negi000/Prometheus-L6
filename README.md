# 🎯 Prometheus-L6

LOTO6戦略的投資支援システム - AI駆動型の包括的分析・意思決定支援ツール

## 🎨 最新アップデート (v2.0)

### ✨ **SVGアイコン導入 & UI/UX刷新**
- **プロ級デザイン**: 幾何学記号（■●◆▲▼）を廃止し、スタイリッシュなSVGアイコンを全面導入
- **Feather Icons風**: モダンで直感的なベクターアイコンによる視認性向上
- **カラー統合**: 成功=緑、エラー=赤、警告=オレンジの統一カラーシステム
- **レスポンシブ対応**: 全デバイスで最適表示される高品質UI

### 🔧 **堅牢性向上**
- **列名自動統一**: CSVデータの「回」列を「第何回」に自動変換
- **エラーハンドリング強化**: データ読み込み・特徴量生成時の安定性向上
- **バックテスト修正**: 「第何回」列エラーの完全解決
- **データ検証**: より柔軟で堅牢なデータ処理エンジン

### 📊 **改善されたUI要素**
- **⚡ ヘッダー**: 稲妻アイコンでブランド力強化
- **📋 ナビゲーション**: 機能別専用アイコンで直感的操作
- **📈 ダッシュボード**: 分析項目ごとの視覚的アイコン表示
- **⭐ 戦略管理**: 学習・バックテスト状況の明確化
- **🎯 予測生成**: ポートフォリオ作成の視覚的ガイド
- **📊 シミュレーション**: リスク分析の分かりやすい表示

---

## 📋 概要

Prometheus-L6は、LOTO6を「運任せのギャンブル」から「データ駆動型の戦略的投資」へと昇華させるためのローカル実行型ツールです。高度なデータ分析とAI技術を駆使し、統計的優位性（エッジ）を追求することで、長期的な収益性を最大化する意思決定支援を提供します。

### ⚡ 主要機能

- **📊 データ分析ダッシュボード**: 過去データの詳細分析と可視化
- **⚙️ 適応学習システム**: AI による自己進化型戦略生成
- **🎯 ポートフォリオ生成**: 軸数字・除外数字対応の最適化
- **💰 ケリー基準**: 理論に基づく最適投資額算出
- **🧪 モンテカルロシミュレーション**: 将来リスクの定量評価
- **⚖️ 戦略比較**: 複数戦略の性能比較・選択支援

## 🛠️ 必要要件

### システム要件
- **OS**: Windows 10/11, macOS, Linux
- **Python**: 3.9以上
- **メモリ**: 4GB以上推奨
- **ストレージ**: 1GB以上の空き容量

### 必要データファイル
1. **LOTO6情報.csv** - LOTO6過去当選データ
   - 列: 第何回, 本数字1-6, ボーナス数字, セット球, 本数字合計 など
   - 文字エンコーディング: Shift-JIS
2. **allloto6.txt** - 全組み合わせデータ（オプション）

## 📦 インストール手順

### 1. プロジェクトのクローン/ダウンロード
```bash
# このディレクトリ構造を作成
Prometheus-L6/
├── main.py
├── config.ini
├── requirements.txt
├── data/
│   ├── LOTO6情報.csv
│   └── allloto6.txt
├── app/
└── output/
```

### 2. Python環境のセットアップ
```bash
# 仮想環境の作成（推奨）
python -m venv venv

# 仮想環境の有効化
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

# 依存パッケージのインストール
pip install -r requirements.txt
```

### 3. データファイルの配置
- `data/LOTO6情報.csv` に過去の当選データを配置
- 必要に応じて `config.ini` の設定を調整

### 4. アプリケーションの起動
```bash
# 仮想環境がアクティブな状態で実行
streamlit run main.py
```

ブラウザで `http://localhost:8501` にアクセスしてください。

> **✅ 起動確認**: 正常に起動すると以下のようなメッセージが表示されます：
> ```
> You can now view your Streamlit app in your browser.
> Local URL: http://localhost:8501
> Network URL: http://10.45.237.75:8501
> ```

## 📚 使用方法

### 初回セットアップ
1. **ダッシュボード**でデータの読み込み確認
2. 特徴量生成を実行（初回のみ、数分要します）
3. システム情報で動作確認

### 基本的なワークフロー

#### 1️⃣ 戦略の学習
1. 「⚙️ 戦略管理」→ 「新規戦略学習」
2. バックテスト期間とパラメータを設定
3. 学習実行（10-30分程度）

#### 2️⃣ 予測の生成
1. 「🔮 予測生成」で学習済み戦略を選択
2. 購入条件（口数、軸数字等）を設定
3. ポートフォリオ生成

#### 3️⃣ リスク評価
1. 「🧪 シミュレーション」で戦略性能を評価
2. 複数戦略の比較検討
3. 最適戦略の選択

## 🧠 核心技術：適応学習システム

本ツールの中核を成すのは、ユーザー定義の「適応学習・バックテストエンジン」です：

### 学習サイクル
1. **直近100回のデータ**を使用してAIモデルを学習
2. **次の1回を予測**してポートフォリオ生成
3. **実際の結果と比較**して性能評価
4. **フィードバック**により次の学習で改善

### バックテスト方式
- スライディングウィンドウ法による厳密な過去検証
- データリーク完全防止
- 継続的な戦略改善

## 📊 動作確認とデータ状況

### ✅ 現在の動作状況
- **データベース**: 正常に初期化済み
- **LOTO6履歴データ**: 2008件正常読み込み
- **文字エンコーディング**: UTF-8自動検出・変換成功
- **列名統一**: '回' → '第何回' 自動変換完了
- **特徴量生成**: 270次元の高次元特徴量対応
- **継続学習**: 実装済み・動作確認済み
- **アンサンブル学習**: 複数モデル統合機能動作中

### 📈 動作ログ例
正常起動時には以下のようなログが表示されます：
```
INFO:app.data_manager:データベースが正常に初期化されました
INFO:app.data_manager:'utf-8' での読み込み成功
INFO:app.data_manager:LOTO6履歴データを読み込みました: 2008件
INFO:app.feature_engine:特徴量生成が完了しました。最終的な列数: 270
INFO:app.backtester:継続学習開始: 第1750回〜第1950回
```

### 🎯 確認済み機能
- ✅ **データ分析ダッシュボード**: 基本統計・ホット/コールドナンバー
- ✅ **新規戦略学習**: XGBoost, RandomForest, アンサンブル
- ✅ **継続学習**: 既存戦略の増分学習・改善
- ✅ **バックテスト**: スライディングウィンドウ検証
- ✅ **予測生成**: ポートフォリオ最適化
- ✅ **シミュレーション**: モンテカルロ・リスク分析

### 1. 特徴量エンジニアリング
- **時系列特徴量**: 移動平均、出現ギャップ、トレンド
- **構造的特徴量**: 奇偶比、連続数、合計値分散
- **セット球プロファイル**: カテゴリ情報の数値化

### 2. 機械学習モデル
- **XGBoost**: 勾配ブースティング（デフォルト）
- **拡張予定**: GNN, VAE, 強化学習

### 3. 投資最適化
- **ケリー基準**: 理論的最適投資額
- **逆張り戦略**: 期待収益最大化
- **リスク分散**: コア・サテライト戦略

## 📊 動作確認とデータ状況

### ✅ 現在の動作状況
- **データベース**: 正常に初期化済み
- **LOTO6履歴データ**: 2008件正常読み込み
- **文字エンコーディング**: UTF-8自動検出・変換成功
- **列名統一**: '回' → '第何回' 自動変換完了
- **特徴量生成**: 270次元の高次元特徴量対応
- **継続学習**: 実装済み・動作確認済み
- **アンサンブル学習**: 複数モデル統合機能動作中

### 📈 動作ログ例
正常起動時には以下のようなログが表示されます：
```
INFO:app.data_manager:データベースが正常に初期化されました
INFO:app.data_manager:'utf-8' での読み込み成功
INFO:app.data_manager:LOTO6履歴データを読み込みました: 2008件
INFO:app.feature_engine:特徴量生成が完了しました。最終的な列数: 270
INFO:app.backtester:継続学習開始: 第1750回〜第1950回
```

### 🎯 確認済み機能
- ✅ **データ分析ダッシュボード**: 基本統計・ホット/コールドナンバー
- ✅ **新規戦略学習**: XGBoost, RandomForest, アンサンブル
- ✅ **継続学習**: 既存戦略の増分学習・改善
- ✅ **バックテスト**: スライディングウィンドウ検証
- ✅ **予測生成**: ポートフォリオ最適化
- ✅ **シミュレーション**: モンテカルロ・リスク分析

## ⚙️ 設定ファイル (config.ini)

```ini
[Paths]
loto6_history_csv = ./data/LOTO6情報.csv
database_path = ./output/db/strategies.db

[Parameters]
backtest_window_size = 100
default_purchase_count = 20
ticket_price = 200

[KellyCriterion]
average_win_prize = 3500
odds_b = 17.5
```

## 🚨 重要な注意事項

### 免責事項
- 本ツールは統計的分析に基づく意思決定支援が目的
- **当選は保証されません**
- 投資は自己責任で実行してください
- 過去の実績は将来の結果を保証しません

### 推奨事項
- 必ず少額から開始
- 複数戦略の分散投資
- 定期的な戦略見直し
- ギャンブル依存症への注意

## 📈 パフォーマンス指標

システムが提供する主要指標：

- **平均損益**: 1回あたりの期待収支
- **的中率**: 3等以上、4等以上、5等以上
- **VaR**: バリュー・アット・リスク（95%, 99%）
- **シャープレシオ**: リスク調整後リターン
- **ROI**: 投資収益率

## 🔧 トラブルシューティング

### よくある問題

1. **データ読み込みエラー**
   - **文字エンコーディングエラー**: `'shift_jis' codec can't decode byte`
     - **原因**: CSVファイルの文字エンコーディングが期待と異なる
     - **解決法**: 
       - Excelで開いて「CSV (カンマ区切り)」として再保存
       - テキストエディタでShift-JISまたはUTF-8として保存
       - システムが自動的に複数エンコーディングを試行
   
   - **ファイルパスエラー**: `FileNotFoundError`
     - **原因**: データファイルが指定された場所にない
     - **解決法**: `data/LOTO6情報.csv` が正しい場所にあることを確認
   
   - **CSVフォーマットエラー**: 列が見つからない
     - **原因**: CSV の列名や構造が期待と異なる
     - **解決法**: 必要な列（回、本数字1-6等）が含まれていることを確認

2. **モデル互換性警告** ⚠️
   - **scikit-learn バージョン警告**: `InconsistentVersionWarning`
     - **症状**: 
       ```
       Trying to unpickle estimator DecisionTreeRegressor from version 1.5.0 
       when using version 1.7.0
       ```
     - **原因**: 古いバージョンで保存されたモデルを新しいバージョンで読み込み
     - **対処法**: 
       - ⚠️ **警告のみで機能に影響なし** - そのまま使用可能
       - 新しい戦略を学習すれば警告は解消されます
       - 既存戦略の再学習で完全解決
   
   - **XGBoost 警告**: 
     - **症状**: `WARNING: If you are loading a serialized model...`
     - **対処法**: 同上（機能に影響なし）

3. **パフォーマンス関連**
   - **メモリ不足**
     - バックテスト期間の短縮
     - 購入口数の削減
     - `config.ini` で `backtest_window_size` を100以下に設定

   - **学習時間が長い**
     - ウィンドウサイズの調整（`backtest_window_size` を50-100に設定）
     - XGBoostパラメータの調整
     - CPUコア数の確認

4. **継続学習エラー** ✅
   - **学習率調整エラー**: `too many values to unpack (expected 2)`
     - **原因**: アンサンブルモデルの内部構造アクセス方法の問題
     - **対処法**: ✅ **修正済み** - より堅牢な学習率調整ロジックに改善
     - **影響**: 学習率調整がスキップされても標準設定で継続学習は正常動作

5. **Streamlitファイル監視エラー** ⚠️
   - **症状**: `RuntimeError: dictionary changed size during iteration`
   - **原因**: Streamlitの内部ファイル監視システムの競合状態
   - **対処法**: 
     - ⚠️ **機能に影響なし** - アプリケーションは正常に動作します
     - ターミナルに表示されるエラーですが、UI操作には影響しません
     - アプリを再起動すれば一時的に解消される場合があります

6. **配列サイズエラー** ✅
   - **症状**: `index 42 is out of bounds for axis 0 with size 42`
   - **原因**: LOTO6の数字範囲（1-43）の処理で42次元配列にアクセスしていた
   - **対処法**: ✅ **修正済み** - 正しく43次元として処理するよう修正
   - **影響**: 継続学習がエラーなく実行されます

9. **ログデータ型エラー** ✅
   - **症状**: `'list' object has no attribute 'get'`
   - **原因**: バックテストログの辞書型・リスト型の混在でアクセス方法が不適切
   - **対処法**: ✅ **修正済み** - 型安全なデータアクセス関数を実装
   - **修正箇所**: 戦略管理・詳細結果表示・予測分析の全関数
   - **影響**: 戦略管理画面・継続学習機能が安定動作します

10. **型安全性・データ整合性エラー** ✅
    - **症状**: `IndexError: single positional indexer is out-of-bounds`, `'<' not supported between instances of 'str' and 'int'`, `KeyError`, `AttributeError`
    - **原因**: 
      - `.iloc[0]` による境界チェック不足
      - 文字列と数値の型混在による比較エラー
      - 辞書・リストの混在によるアクセスエラー
      - データ型変換の不徹底
    - **対処法**: ✅ **修正済み** - 全ファイルで型安全性を徹底強化
      - **data_manager.py**: 「第何回」「本数字」「ボーナス数字」の確実な数値型変換
      - **feature_engine.py**: 回号列の型変換とリネーム処理の堅牢化
      - **strategy_management.py**: 戦略データ取得の境界チェック
      - **detailed_results.py**: ヒートマップ・データアクセスの安全化
      - **backtester.py**: セット球・当選番号取得の型安全化
      - **prediction.py**: 辞書アクセスの型チェック強化
      - **dashboard.py**: 統計計算の型安全化
    - **影響**: 全機能で型関連エラーが根本的に防止されます

### エンコーディング問題の詳細解決手順

**方法1: Excelを使用**
1. CSVファイルをExcelで開く
2. 「ファイル」→「名前を付けて保存」
3. ファイル形式を「CSV (カンマ区切り) (*.csv)」に選択
4. 保存

**方法2: テキストエディタ使用**
1. CSVファイルをメモ帳やVS Codeで開く
2. 「名前を付けて保存」で文字エンコーディングを「ANSI」または「UTF-8」に設定
3. 保存

**方法3: Pythonスクリプトで変換**
```python
import pandas as pd

# UTF-8で読み込み
df = pd.read_csv('data/LOTO6情報.csv', encoding='utf-8')
# Shift-JISで保存
df.to_csv('data/LOTO6情報_fixed.csv', encoding='shift-jis', index=False)
```

### システム要件確認

```bash
# Python バージョン確認
python --version

# 必要パッケージの確認
pip list | grep -E "(pandas|streamlit|sklearn|xgboost)"

# メモリ使用量確認（起動後）
# タスクマネージャー（Windows）またはActivity Monitor（Mac）で確認
```

## 📝 ライセンス

本プロジェクトは個人利用を前提としています。

## 🤝 貢献

改善提案やバグ報告は Issue でお願いします。

## 📧 サポート

技術的な質問や要望については、プロジェクトの Issue を活用してください。

---

## 🎉 最新ステータス (2025年6月26日)

### ✅ **完全動作確認済み**
Prometheus-L6は現在、**完全に動作する状態**です：

- **✅ インストール完了**: 全依存パッケージ正常動作
- **✅ データ読み込み**: 2008件のLOTO6履歴データ処理成功
- **✅ 特徴量生成**: 270次元の高度特徴量エンジン稼働
- **✅ AI学習機能**: XGBoost/RandomForest/アンサンブル対応
- **✅ 継続学習**: 既存戦略の段階的改善機能
- **✅ リアルタイム予測**: ポートフォリオ最適化実装
- **✅ バックテスト**: 過去データでの戦略検証
- **✅ UI/UX**: SVGアイコン・モダンデザイン
- **✅ エラーハンドリング**: 堅牢な例外処理とデータ整合性保証
- **✅ 配列サイズ問題**: LOTO6の43次元対応完了
- **✅ 継続学習安定性**: キーエラーと例外処理を完全修正

### 🔧 **最新の修正項目 (2025年6月26日)**

1. **42次元→43次元修正**: LOTO6の正しい数字範囲（1-43）に対応
2. **継続学習エラー修正**: `hits_detail`, `cost`キーエラーを解決
3. **UI改善**: 学習率調整係数の詳細説明と横並びレイアウト
4. **安全なキーアクセス**: 例外時でもデータ整合性を保証
5. **Streamlit監視エラー対応**: 機能に影響しない警告の説明追加
6. **型安全なログ処理**: `'list' object has no attribute 'get'`エラーを完全解決
   - バックテストログの辞書型・リスト型混在問題を修正
   - 戦略管理画面での型安全なデータアクセス実装
   - 継続学習機能の堅牢性向上
   - バックテスト詳細表示での全データ型対応
7. **バックテスト詳細表示の改善**: UI/UX問題を総合的に解決
   - 表示件数切り替え時のリダイレクト問題をセッション管理で修正
   - 予想チケット数の明示表示（「予想チケット数: N通り」）
   - 大量チケット時の表示制御（20通り超過時のオプション表示）
   - ボーナス数字列名の統一対応（「ボーナス」「ボーナス数字」両対応）
   - ボーナス数字未取得時の診断メッセージ追加
8. **予想チケット数制限の解除**: 戦略本来の性能を発揮
   - 継続学習での5通り制限を削除（設定通り20通りに復活）
   - ランダム生成時の10通り制限も解除
   - フォールバック処理の5通り制限も解除
   - ボーナス数字取得の詳細ログ追加（デバッグ強化）
   - ✅ **効果確認済み**: 新規戦略学習で正常に動作確認済み
9. **新規戦略学習時のエラー修正**: 特徴量重要度表示の型安全化
   - 文字列と数値の比較エラー（`'<' not supported between instances of 'str' and 'int'`）を解決
   - 特徴量重要度データの型変換と検証を強化
   - エラーハンドリングの詳細化とデバッグ情報の充実
10. **🔧 徹底的な型安全化・データ整合性強化 (NEW!)**
    - **strategy_management.py**: `.iloc[0]` によるIndexErrorを防止する型安全な戦略データ取得
    - **detailed_results.py**: ヒートマップ生成とデータアクセスの境界チェック強化
    - **backtester.py**: セット球情報取得と当選番号取得の型安全化、新規 `_get_actual_numbers_safe()` メソッド追加
    - **prediction.py**: kelly_info・portfolio 辞書アクセスの型チェック追加
    - **strategy.py/simulator.py**: strategy_performance 辞書の型検証強化
    - **data_manager.py**: 「第何回」「本数字」「ボーナス数字」列の確実な数値型変換
    - **feature_engine.py**: 回号列の型変換とリネーム処理の堅牢化
    - **dashboard.py**: 統計計算（平均・最大値）の型安全な処理
    - **simulation.py**: 戦略選択オプション作成時の型チェック
    - **🎯 効果**: `'list' object has no attribute 'get'`、`'<' not supported between instances of 'str' and 'int'`、IndexError等の再発を根本防止

### 🚀 **即座に利用可能**
```bash
# 1. プロジェクトディレクトリに移動
cd "c:\Users\241822\Desktop\新しいフォルダー (2)\Prometheus-L6"

# 2. 仮想環境をアクティベート
.venv\Scripts\activate

# 3. アプリケーション起動
streamlit run main.py

# 4. ブラウザでアクセス
# http://localhost:8501
```

**Prometheus-L6** - AIによる戦略的LOTO6投資の新時代へ 🚀
